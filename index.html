<html><head>
<title>Cuckoo Filter and Bloom Filter By Example</title>
<style>
#content {
  width: 70%;
  margin: auto;
  background-color: #fff;
  padding: 20px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  border-radius: 10px;
}
body {
  background-color: #d3ddb4;
  color: black;
  font-family: Palatino, Georgia, "Times New Roman", Times, serif;
  font-size: 17px;
}
table.superstructure {
   /*border: 2px solid black;*/
}
table.superstructure td {
   /*border: 2px solid black;*/
   padding: 20px;
   text-align: center;
}
table.superstructure th {
   /*border: 2px solid black;*/
   text-align: center;
}
.insetbox {
  margin: auto;
  background-color: #f1f1ce;
  padding: 10px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  border-radius: 10px;
}
table.bitvector {
  /*font-size: 14pt;*/
  border-width: 1px;
  border-spacing: 0px;
  border-style: none;
  border-color: rgb(51, 51, 51);
  border-collapse: collapse;
  background-color: white;
  margin: auto;
  border-collapse: collapse;
  font-family: monospace;
  text-align: center;
}
table.bitvector th {
  height: 2em;
  width: 2em;
  border-width: 1px;
  padding: 1px;
  border-style: solid;
  border-color: rgb(221, 221, 221);
  background-color: white;
  -moz-border-radius: ;
}
table.bitvector td {
  height: 2em;
  width: 2em;
  border-width: 1px;
  padding: 0px;
  border-style: solid;
  border-color: rgb(221, 221, 221);
  background-color: white;
  -moz-border-radius: ;
}
table.bitvector .unused {
  background-color: rgb(241, 241, 206);
  color: rgb(241, 241, 206);
  border-style: none;
}
.live {
  background-color: green !important;
  color: white;
}
.hit {
  background-color: orange !important;
  color: white;
}
.kicked {
  background-color: red !important;
  color: white;
}
.unkicked {
  background-color: darkred !important;
  color: white;
}
.vertical-text {
  transform: rotate(270deg);
  transform-origin: right bottom 0;
  float: left;
}

</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="jquery.tinypubsub.js"></script>
<script src='murmurhash.js'></script>
<script>
var EMPTY = '\240';
// var BULLET = '\u2219';
// var BULLET = '\u2b24';
var BULLET = '\u2b25';
// var BULLET = '\u2776';
var NUMBITS = 140; // must > 0 and a multiple of 32 for this demo
var NUM_BITS_PER_ENTRY = 7;
var NUM_VALS_PER_ENTRY = Math.pow(2, NUM_BITS_PER_ENTRY);
var MAX_KICKS = 50;

function pad(i) {
  return ("0000" + i).slice(-2);
}

$(function() {
  Array.prototype.remove = function(item) {
    var index = this.indexOf(item);
    return (index >= 0) ? this.splice( index, 1 ) : null;
  };

  Array.prototype.random = function() {
    return this[Math.floor(Math.random()*this.length)];
  };

  var multiset = [];

  $.subscribe('/multiset/insert', function(val){
    multiset.push(val);
    $.publish('/multiset/modified', ['insert', val, multiset]);
  });

  $.subscribe('/multiset/remove', function(val){
    if (multiset.remove(val)) {
      $.publish('/multiset/modified', ['remove', val, multiset]);
    }
  });

  function hashes(val) {
    var ret=[];
    for (var i=0; i<NUM_BITS_PER_ENTRY; i++) {
      ret.push(murmur(i + val));
    }
    return ret;
  }

  function fingerprint(val) {
    // return a UTF-8 math symbol to represent a 4-bit fingerprint
    // return '1234567890ABCDEF'.charAt(murmur('fingerprint' + val) % NUM_VALS_PER_ENTRY);
    // return String.fromCharCode((murmur('fingerprint' + val) % NUM_VALS_PER_ENTRY) * 5 + 8704);
    // return String.fromCharCode((murmur('XXfingerprintXX' + val) % NUM_VALS_PER_ENTRY) + 10744);
    // return String.fromCharCode((murmur('XXfingerprintXX' + val) % NUM_VALS_PER_ENTRY) + 9812);
    return "" + (murmur('XXfingerprintXX' + val) % NUM_VALS_PER_ENTRY + 1);
  }

  $.subscribe("/input/live/insert", function(event, val){
    // handle enter key
    if (event.keyCode == '13') {
      event.preventDefault();
      if ('' != val) $.publish(event.shiftKey ? '/input/remove' : '/input/insert', val);
    }
  });

  $.subscribe("/input/live", function(val){
    if ("" == val) return;
    $.publish("/live/hashes", [hashes(val), fingerprint(val)]);
  });

  $.subscribe("/input/insert", function(val){
    if (val == '') return;
    $.publish("/multiset/insert", val);
  });

  $.subscribe("/input/remove", function(val){
    if (val == '') return;
    $.publish("/multiset/remove", val);
  });

  $.subscribe('/multiset/modified', function(action, val, multiset){
    $.publish('/last/action', [action, val, hashes(val), fingerprint(val)]);
    $.publish('/action/' + action, [val, hashes(val), fingerprint(val)]);
  });

  $("#inputStr").focus();
});

</script>
</head><body>
<div id='content'>
    <h1>Cuckoo Filter and Bloom Filter By Example</h1>

    <div class="insetbox" align="center">
      <table class="superstructure">
        <tr><th>Cuckoo Filter</th><th>Bloom Filter</th></tr>
        <tr>
          <td valign="top">
            <span class="vertical-text">Buckets</span>
            <table id="cuckooFilter" class="bitVector" border=1 cellpadding=0 cellspacing=0>
            </table>
            <script>
              var cuckooEntriesPerBucket = 2; // 2, 4, or 8
              var cuckooBucketCount = NUMBITS / cuckooEntriesPerBucket / NUM_BITS_PER_ENTRY;

              // add the table cells which represent our cuckoo filter bit array
              for (var bucket=0; bucket<cuckooBucketCount; bucket++) {
                $("#cuckooFilter").append('<tr id="cuckooBucket' + bucket + '"></tr>');
                $("#cuckooBucket" + bucket).append('<th id="cuckooBucketIndex' + bucket + '">' + pad(bucket) + '</th>');
                for (var entry=0; entry<cuckooEntriesPerBucket; entry++) {
                  $("#cuckooBucket" + bucket).append('<td id="cuckooEntry' + pad(bucket) + pad(entry) + '">&nbsp</td>');
                }
              }

              function mod(i, m) {
                var ret = i % m;
                return (ret >=0 ) ? ret : m + ret;
              }

              function parsign(i) {
                return (Math.abs(i) % 2) * -2 + 1;
              }

              function odd(i) {
                return i % 2 == 0 ? i+1 : i;
              }

              function cuckooIndex(hash) {
                return hash % cuckooBucketCount;
              }

              function cuckooAltIndex(bucket, fingerprint) {
                return mod(bucket + (parsign(bucket) * odd(murmur(fingerprint))), cuckooBucketCount);
              }

              function cuckooBuckets(hash, fingerprint) {
                var index = cuckooIndex(hash);
                var altIndex = cuckooAltIndex(index, fingerprint);
                return [index, altIndex];
              }

              function _cuckooPutEntry(fingerprint, bucket, kick) {
                if (kick > MAX_KICKS) return false;

                // if empty @ bucket or alt bucket, insert fingerprint and return true
                var altBucket = cuckooAltIndex(bucket, fingerprint);

                var entry = 
                  $("[id^=cuckooEntry" + pad(bucket) + "]:contains(" + EMPTY + ")").toArray().random()
                  ||
                  $("[id^=cuckooEntry" + pad(altBucket) + "]:contains(" + EMPTY + ")").toArray().random();
                  ;

                if (entry) {
                  $(entry).addClass('kicked').text(fingerprint);
                  return entry;
                }

                // pick an entry to kick an entry, store kicked fprint & entry, insert fingerprint, putEntry kicked, altIndex(kicked)
                entry = $("[id^=cuckooEntry" + pad(bucket) + "]").toArray().random();
                var kickedFingerprint = $(entry).text();
                $(entry).addClass('kicked').text(fingerprint);

                if (! _cuckooPutEntry(kickedFingerprint, cuckooAltIndex(bucket, kickedFingerprint), kick + 1) ) {
                  // kicks failed to find an open entry, undo
                  $(entry).addClass('unkicked').text(kickedFingerprint);
                  return false;
                }

                return entry;
              }

              function cuckooPutEntry(fingerprint, bucket) {
                return _cuckooPutEntry(fingerprint, bucket, 0);
              }

              function cuckooClearHilites(){
                $('#cuckooFilter .live').removeClass('live');
                $('#cuckooFilter .hit').removeClass('hit');
                $('#cuckooFilter .kicked').removeClass('kicked');
                $('#cuckooFilter .unkicked').removeClass('unkicked');
              }

              $.subscribe('/live/hashes', function(hashes, fingerprint){
                cuckooClearHilites();
                var buckets = cuckooBuckets(hashes[0], fingerprint);
                buckets.forEach(function(bucket){
                  $("#cuckooBucketIndex" + bucket).addClass('live');
                  $("[id^=cuckooEntry" + pad(bucket) + "]:contains(" + EMPTY + ")").addClass('live');
                  $("[id^=cuckooEntry" + pad(bucket) + "]:contains(" + fingerprint + ")").addClass('hit');
                });
              });

              $.subscribe('/action/insert', function(val, hashes, fingerprint){
                cuckooClearHilites();
                var buckets = cuckooBuckets(hashes[0], fingerprint);
                var entry = cuckooPutEntry(fingerprint, buckets[0]) || cuckooPutEntry(fingerprint, buckets[1]);
                if (entry) {
                  $(entry).removeClass('kicked').addClass('hit');
                  $.publish('/cuckoo/modified');
                }
              });

              $.subscribe('/action/remove', function(val, hashes, fingerprint){
                cuckooClearHilites();
                var buckets = cuckooBuckets(hashes[0], fingerprint);
                var entry = 
                  $("[id^=cuckooEntry" + pad(buckets[0]) + "]:contains(" + fingerprint + ")").toArray().random()
                  ||
                  $("[id^=cuckooEntry" + pad(buckets[1]) + "]:contains(" + fingerprint + ")").toArray().random();
                  ;

                if (entry) {
                  $(entry).addClass('hit').text(EMPTY);
                  $.publish('/cuckoo/modified');
                }
              });

            </script>

            <span class='stats'>
              <p>FPP: <span id='cuckooFPP'>0</span>%</p>
              <p>In filter: <span id='liveInCuckoo'></span></p>
              <p>Fingerprint (<span id='cuckooBitsPerFp'></span>-bit): <span id='liveFingerprint'></span></p>
            </span>
            <script>
              $(function() {
                $('#cuckooBitsPerFp').text("" + NUM_BITS_PER_ENTRY);
              });
              $.subscribe('/cuckoo/modified', function(){
                var totalEntries = $("[id^=cuckooEntry]").toArray().length;
                var empties = $("[id^=cuckooEntry]:contains(" + EMPTY + ")").toArray().length;
                var occupied = totalEntries - empties;
                var load = occupied / totalEntries;

                var fpp = 1.0 - Math.pow( (NUM_VALS_PER_ENTRY - 1) / NUM_VALS_PER_ENTRY, 2 * cuckooEntriesPerBucket * load );

                1.0 - Math.pow( ( NUM_VALS_PER_ENTRY - 1 ) / NUM_VALS_PER_ENTRY, 2 * cuckooEntriesPerBucket * load )


                $('#cuckooFPP').text((100 * fpp).toFixed(4));
              });

              $.subscribe('/live/hashes', function(hashes, fingerprint){
                $("#liveFingerprint").text(fingerprint);
                var buckets = cuckooBuckets(hashes[0], fingerprint);
                var entry = 
                  $("[id^=cuckooEntry" + pad(buckets[0]) + "]:contains(" + fingerprint + ")").toArray().shift()
                  ||
                  $("[id^=cuckooEntry" + pad(buckets[1]) + "]:contains(" + fingerprint + ")").toArray().shift();
                  ;

                if (entry) {
                  $("#liveInCuckoo").addClass('hit').text("maybe");
                } else {
                  $("#liveInCuckoo").removeClass('hit').text("nope");
                }
              });
            </script>
          </td>
          <td valign="top">
            <table id="bloomFilter" class="bitVector" border=1 cellpadding=0 cellspacing=0>
            </table>
            <script>
              // // add the table cells which represent our bloom filter bit array
              // var bitsPerSegment = 16;
              // for (var segment=0; segment<NUMBITS/bitsPerSegment; segment++) {
              //   $("#bloomFilter").append('<tr id="bloomSegment' + segment.toString(bitsPerSegment) + '"></tr>');
              //   $("#bloomFilter").append('<tr id="bloomBits' +  segment.toString(bitsPerSegment) + '"></tr>');
              //   for (var i=0; i<bitsPerSegment; i++) {
              //     var bit = (bitsPerSegment * segment) + i;
              //     if (bit < NUMBITS) {
              //       $("#bloomSegment" + segment).append('<th id="bloomIndex' + bit + '">' + pad(bit.toString(bitsPerSegment)) + '</th>');
              //       $("#bloomBits" + segment).append('<td id="bloomBit' + bit.toString(bitsPerSegment) + '">&nbsp;</td>');
              //     } else {
              //       debugger;
              //       $("#bloomSegment" + segment).append('<th class="unused">&nbsp;</th>');
              //       $("#bloomBits" + segment).append('<td class="unused">&nbsp;</td>');
              //     }
              //   }
              // }

              // add the table cells which represent our bloom filter bit array
              var bitsPerSegment = 16;
              $("#bloomFilter").append('<tr id="bloomOnes"><th class="unused"></th></tr>');
              for (var i=0; i<bitsPerSegment; i++) {
                $("#bloomOnes").append('<th id="bloomOnes' + i + '">' + i.toString(bitsPerSegment).toUpperCase().substring(-1) + '</th>');
              }

              for (var segment=0; segment<NUMBITS/bitsPerSegment; segment++) {
                var segStr = segment.toString(bitsPerSegment);
                $("#bloomFilter").append('<tr id="bloomSeg' +  segStr + '"><th>' + segStr.toUpperCase() + '</th></tr>');

                for (var i=0; i<bitsPerSegment; i++) {
                  var bit = (bitsPerSegment * segment) + i;
                  if (bit < NUMBITS) {
                    $("#bloomSeg" + segStr).append('<td id="bloomBit' + bit + '">&nbsp;</td>');
                  } else {
                    $("#bloomSeg" + segStr).append('<td class="unused"></td>');
                  }
                }
              }

              function bloomIndex(hash) { return hash % NUMBITS }

              $.subscribe('/live/hashes', function(hashes, fingerprint){
                $('#bloomFilter .live').removeClass('live');
                $('#bloomFilter .hit').removeClass('hit');
                hashes.map(bloomIndex).forEach(function(i){
                  $('#bloomBit' + i + ', #bloomIndex' + i).addClass('live');
                  if ($('#bloomBit' + i).text() != EMPTY) {
                    $('#bloomBit' + i).addClass('hit');
                  }
                });
              });

              $.subscribe('/action/insert', function(val, hashes, fingerprint){
                hashes.map(bloomIndex).forEach(function(i){$('#bloomBit' + i).text(BULLET).addClass('hit')});
                $.publish('/bloom/modified');
              });
            </script>

            <span class='stats'>
              <p>FPP: <span id='bloomFpp'>0</span>%</p>
              <p>In filter: <span id='liveInBloom'></span></p>
            </span>
            <script>
              $.subscribe('/bloom/modified', function(){
                var occupied = $("[id^=bloomBit]:contains(" + BULLET + ")").toArray().length;
                var fpp = Math.pow(occupied / NUMBITS, NUM_BITS_PER_ENTRY);
                $('#bloomFpp').text((fpp * 100).toFixed(6));
              });

              $.subscribe('/live/hashes', function(hashes, fingerprint){
                var inBloom = 
                  hashes
                    .map(bloomIndex)
                    .every(function(i){return $('#bloomBit' + i).text() != EMPTY});
                if (inBloom) {
                  $("#liveInBloom").addClass('hit').text("maybe");
                } else {
                  $("#liveInBloom").removeClass('hit').text("nope");
                }
                
              });
            </script>
          </td>
        </tr>
      </table>
    </div>
    <br />
    <div class='insetbox inputarea'>
        <p>
          Enter a string: <input id='inputStr' 
          onkeydown='$.publish("/input/live/insert", [event, value])'
          onkeyup='$.publish("/input/live", value)'
          >
          <button onclick='$.publish("/input/insert", $("#inputStr").val())'>insert</button>
          <button onclick='$.publish("/input/remove", $("#inputStr").val())'>remove</button>
        </p>
        <script>
          $.subscribe('/multiset/modified', function(){ $('#inputStr').val(''); $("#inputStr").focus();});
        </script>

<!--         <p>Hash: <span id='liveHash'></span></p>
        <script>
          $.subscribe('/live/hashes', function(hashes, fingerprint){
            $('#liveHash').text(hashes.join(", ")+ " (" + fingerprint + ")");
          });
        </script>

        <p>Last Action: <span id='setActions'></span></p>
        <script>
          $.subscribe('/last/action', function(action, val, hashes, fingerprint){
            $('#setActions').text(action + ': ' + val + ", " + hashes.join(", ") + " (" + fingerprint + ")");
          });
        </script>

 -->        <p>MultiSet: <span id='setContents'></span></p>
        <script>
          $.subscribe('/multiset/modified', function(action, val, set){
            $('#setContents').text(set.join(", "));
          });
        </script>
    </div>
</div>
</body></html>
